<html>
<head>
    <title>Search Wiz</title>
    <link rel="stylesheet" type="text/css" href="/style"></style>
</head>
<body>
    <div class="content">
        <input type="text" class="search-input" name="search"><br><br><br>
        <input type="radio" id="by-keyword" name="searchtype" value="keyword" checked> by Keyword &nbsp; &nbsp;
        <input type="radio" id="by-id" name="searchtype" value="id"> by Id<br>
        <button class="search-button">Search</button>
        <div class="response"></div>
    </div>
    <div class="overlay start-hidden">
        <div id="spinner"></div>
    </div>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
<script>
    $(function() {
        var Tracks = Backbone.Collection.extend({});

        var View = Backbone.View.extend({
            el: 'body',

            events: {
                'keyup .search-input': 'handleReturnPress',
                'click .search-button': 'doSearch'
            },

            initialize: function() {
                this.collection = new Tracks;
                this.listenTo(this.collection, 'sync add reset set change', this.onLoad);
                setTimeout(function(){
                    this.$('.search-input').focus();
                }.bind(this),200);
            },

            handleReturnPress: function(event){
                var code = event.which;
                if(code==13){
                    this.doSearch();
                }
            },

            isNumberInput: function(input) {
                var isNumber = !isNaN(parseFloat(input));
                if(isNumber){
                    this.$('#by-keyword').prop('checked', '');
                    this.$('#by-id').prop('checked', 'checked');
                } else {
                    this.$('#by-id').prop('checked', '');
                    this.$('#by-keyword').prop('checked', 'checked');
                }
                return isNumber;
            },

            clearResponse: function() {
                this.$('.response').html('');
            },

            loadData:function() {
                this.collection.url = this.url;
                this.collection.fetch({type: 'POST'})
                .error(function(){
                    this.$('.response').html('no results found');
                    this.$('.overlay').hide();
                }.bind(this));
            },

            onLoad: function() {
                // needs to be refactoerd to spit out backbone subviews
                var output = '';
                if(this.collection.length === 1) {
                    var data = this.collection.models[0];
                    var artUrl = data.get('artwork_url') ? data.get('artwork_url') : data.get('user').avatar_url;
                    output = '<div class="track"><img src="' + artUrl + '"><br>' + data.get('id') + ' ' + data.get('title') + '</div>';
                } else if(this.collection.length > 1){
                    _.each(this.collection.models, function(song) {
                        var artUrl = song.get('artwork_url') ? song.get('artwork_url') : song.get('user').avatar_url;
                        output += '<div class="track"><img src="' + artUrl + '"><br>' + song.get('id') + ' ' + song.get('title') + '</div>';
                    })
                }
                this.$('.response').html( output );
                this.$('.overlay').hide();
            },

            doSearch: function() {
                var input = $('.search-input').val();
                if(!input) {return false};
                input = input.replace(/ /g, '+');  // convert spaces to pluses

                this.clearResponse();
                this.$('.overlay').show();
                this.url = (!this.isNumberInput(input)) ? '/search/?q=' + input : '/search/track?id=' + input;
                this.loadData();
            },
        });

        var view = new View({});
    });
</script>

</body>
</html>
